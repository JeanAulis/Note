# 健康圈子评论表设计

## 结构总览

1. **topic（话题表）**
    负责分类、绑定设备、审核。
2. **comment（帖子 + 评论表）**
    支撑内容主体、回复、点赞/点踩、排序逻辑。
3. **audit_record（审核记录表）**
    记录人工审核、复审等全过程。

```tex
Topic(话题)
 └── Comment(帖子/评论)
       ├── 子评论（path 枚举）
       ├── 点赞/点踩（like_count / dislike_count）
       ├── 审核状态（status / audit_stage）
       ├── 审核记录（audit_record 表）
       └── 后续扩展：举报 / AI 审核 / 图片
```



## 详细表设计

### `Topic`话题表

| 字段名        | 类型              | 说明                                   |
| ------------- | ----------------- | -------------------------------------- |
| id            | bigint            | 主键，雪花算法ID                       |
| name          | varchar(100)      | 话题名称（如“健康饮食”、“设备维护”）   |
| description   | varchar(500)      | 话题描述                               |
| cover_url     | varchar(255)      | 话题封面图（未来推荐页展示）           |
| device_id     | bigint            | 关联设备ID（可空，用于“设备话题”推荐） |
| creator_id    | bigint            | 创建者ID                               |
| status        | tinyint DEFAULT 0 | 审核状态：0待审核，1通过，2驳回，3封禁 |
| hidden        | tinyint DEFAULT 0 | 是否隐藏（逻辑隐藏）                   |
| audit_time    | datetime          | 最近一次审核时间                       |
| audit_user_id | bigint            | 最近审核人ID                           |
| create_time   | datetime          | 创建时间                               |
| update_time   | datetime          | 更新时间                               |

> [!note]
>
> **为什么要有 topic？**
> 因为你希望不仅是“评论”，而是能在“设备详情页”或“健康分类页”中做**主题推荐和聚合展示**。
> 这样前端就能通过 topic_id 拉出一整类讨论。

---

### `comment`评论与帖子表

| 字段名        | 类型                   | 说明                                     |
| ------------- | ---------------------- | ---------------------------------------- |
| id            | bigint                 | 主键（雪花算法ID）                       |
| topic_id      | bigint                 | 所属话题ID（冗余）                       |
| target_id     | bigint                 | 评论目标ID（帖子或评论）                 |
| target_type   | tinyint                | 0=帖子，1=评论                           |
| content       | text                   | 内容文本                                 |
| user_id       | bigint                 | 用户ID                                   |
| ip_address    | varchar(45)            | IP 地址（用于定位）                      |
| location      | varchar(100)           | 发布位置（冗余中文地址）                 |
| path          | varchar(255)           | 路径枚举，`1/`、`1/5/8/`                 |
| root_id       | bigint                 | 根评论ID（一级评论的ID）                 |
| depth         | tinyint                | 层级深度，根评论为1                      |
| like_count    | int DEFAULT 0          | 点赞数                                   |
| dislike_count | int DEFAULT 0          | 点踩数                                   |
| weight        | decimal(6,2) DEFAULT 0 | 综合权重（排序参考，AI/规则调整）        |
| hidden        | tinyint DEFAULT 0      | 是否隐藏（用户删除或屏蔽，以及设为私密） |
| is_deleted    | tinyint DEFAULT 0      | 是否逻辑删除                             |
| status        | tinyint DEFAULT 0      | 内容状态：0未审核，1通过，2封禁，3复审中 |
| audit_stage   | tinyint DEFAULT 0      | 审核阶段：0未审，1初审，2复审，3终审     |
| audit_user_id | bigint                 | 当前审核人                               |
| audit_time    | datetime               | 当前审核时间                             |
| create_time   | datetime               | 创建时间                                 |
| update_time   | datetime               | 更新时间                                 |

> [!note]
>
> 字段设计说明（why）
>
> - **topic_id**
>    让评论或帖子可被直接聚合到某个话题下（查询性能极高，不必跨表 join topic）。
> - **ip_address + location**
>    用于前端展示“来自上海的用户”，以及反作弊（同 IP 高频发帖）。(<font style="color:red">获取IP的权限？如何获取？</font>)
> - **like_count / dislike_count + weight**
>    点赞/点踩是用户偏好信号，`weight` 是综合指标（可以通过定时任务结合点赞、评论时间、活跃度、金主特权等计算排序）。
>    → 比如：`weight = like_count - dislike_count + log(评论热度指数)`
> - **audit_stage / audit_user_id / audit_time**
>    让系统能追踪“初审 → 复审 → 终审”的完整流程；
>    后续可以做人工风控分析或复核仲裁。
> - **hidden / is_deleted**
>    用户个人隐藏 ≠ 系统逻辑删除。
>    这是审核体系和用户维权的重要区分。

> [!tip]
>
> 索引设计
>
> ```sql
> CREATE INDEX idx_topic ON comment(topic_id);
> CREATE INDEX idx_target ON comment(target_type, target_id);
> CREATE INDEX idx_root ON comment(root_id);
> CREATE INDEX idx_user ON comment(user_id);
> CREATE INDEX idx_status ON comment(status);
> CREATE INDEX idx_weight ON comment(weight);
> CREATE INDEX idx_create_time ON comment(create_time);
> ```

---

### `audit_record`审核记录表

| 字段名        | 类型         | 说明                          |
| ------------- | ------------ | ----------------------------- |
| id            | bigint       | 主键                          |
| comment_id    | bigint       | 被审核的评论ID                |
| stage         | tinyint      | 审核阶段：1初审，2复审，3终审 |
| audit_user_id | bigint       | 审核人ID                      |
| result        | tinyint      | 审核结果：1通过，2驳回        |
| reason        | varchar(255) | 审核备注 / 拒绝原因           |
| create_time   | datetime     | 审核时间                      |

> [!note]
>
> 为什么单独建？
>
> 审核过程是有历史轨迹的，不能只留当前状态。
>  拆表后可支持：
>
> - 复审回溯；
> - 风控统计；
> - 审核绩效分析；
> - 后期接入 AI 审核对比人工结论。