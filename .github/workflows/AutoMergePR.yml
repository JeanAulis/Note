name: Auto-Merge to Main
# ä»…åœ¨æ·»åŠ æ ‡ç­¾æ—¶è§¦å‘ï¼Œæ£€æŸ¥ Auto-merge æ ‡ç­¾åå¯ç”¨ GitHub auto-merge

on:
  pull_request:
    types: [labeled, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'Auto-merge'  # åªå¤„ç† Auto-merge æ ‡ç­¾
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ PR æ˜¯å¦ç¬¦åˆå¯ç”¨æ¡ä»¶
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_OWNER=$(gh repo view ${{ github.repository }} --json owner -q ".owner.login")
          LOG_FILE="pr_enable_log_${PR_NUMBER}.md"

          echo "ğŸ” æ­£åœ¨æ£€æŸ¥ PR #$PR_NUMBER"
          echo "# PR #$PR_NUMBER å¯ç”¨æ—¥å¿— - $(date)" > $LOG_FILE
          echo "" >> $LOG_FILE

          # è·å– PR ä¿¡æ¯
          PR_INFO=$(gh pr view $PR_NUMBER --json author,labels,baseRefName,mergeable)
          PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')
          PR_BASE=$(echo "$PR_INFO" | jq -r '.baseRefName')
          PR_MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')

          echo "## PR ä¿¡æ¯" >> $LOG_FILE
          echo "- ä½œè€…: $PR_AUTHOR" | tee -a $LOG_FILE
          echo "- ç›®æ ‡åˆ†æ”¯: $PR_BASE" | tee -a $LOG_FILE
          echo "- å¯åˆå¹¶çŠ¶æ€: $PR_MERGEABLE" | tee -a $LOG_FILE
          echo "" >> $LOG_FILE

          echo "## æ£€æŸ¥ç»“æœ" >> $LOG_FILE
          SHOULD_ENABLE=true

          # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯
          if [ "$PR_BASE" != "main" ]; then
            echo "âŒ ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ main,è·³è¿‡" | tee -a $LOG_FILE
            SHOULD_ENABLE=false
          else
            echo "âœ… ç›®æ ‡åˆ†æ”¯æ˜¯ main" | tee -a $LOG_FILE
          fi

          # æ£€æŸ¥å†²çªçŠ¶æ€ï¼ˆGitHub auto-merge ä¼šè‡ªåŠ¨å¤„ç†åç»­å˜åŒ–ï¼‰
          if [ "$PR_MERGEABLE" = "CONFLICTING" ]; then
            echo "âŒ å­˜åœ¨åˆå¹¶å†²çª,è·³è¿‡ï¼ˆåç»­è§£å†³å GitHub ä¼šè‡ªåŠ¨åˆå¹¶ï¼‰" | tee -a $LOG_FILE
            SHOULD_ENABLE=false
          else
            echo "âœ… æ— åˆå¹¶å†²çª" | tee -a $LOG_FILE
          fi

          # å®¡æ‰¹æ£€æŸ¥
          PR_REVIEWS=$(gh pr view $PR_NUMBER --json reviews -q '.reviews[] | .state' 2>/dev/null || echo "")
          if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
            echo "âœ… ä½œè€…æ˜¯ä»“åº“æ‰€æœ‰è€…,è·³è¿‡å®¡æ‰¹" | tee -a $LOG_FILE
          elif echo "$PR_REVIEWS" | grep -q "APPROVED"; then
            echo "âœ… PR å·²æ‰¹å‡†" | tee -a $LOG_FILE
          else
            echo "âŒ PR æœªæ‰¹å‡†,è·³è¿‡" | tee -a $LOG_FILE
            SHOULD_ENABLE=false
          fi

          # è¾“å‡ºç»“æœ
          echo "" >> $LOG_FILE
          echo "## æœ€ç»ˆç»“æœ" >> $LOG_FILE
          if [ "$SHOULD_ENABLE" = true ]; then
            echo "âœ… æ¡ä»¶ç¬¦åˆï¼Œå¼€å§‹å¯ç”¨ auto-merge" | tee -a $LOG_FILE
            # å¯ç”¨ auto-mergeï¼ˆmerge ç­–ç•¥ï¼Œä½¿ç”¨ merge commitï¼‰
            if gh pr merge $PR_NUMBER --auto --merge; then
              echo "âœ… Auto-merge å·²å¯ç”¨ï¼ŒGitHub å°†æŒç»­ç›‘æ§å¹¶è‡ªåŠ¨åˆå¹¶" | tee -a $LOG_FILE
            else
              echo "âŒ å¯ç”¨å¤±è´¥" | tee -a $LOG_FILE
              exit 1
            fi
          else
            echo "âŒ ä¸ç¬¦åˆæ¡ä»¶" | tee -a $LOG_FILE
          fi

      - name: ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-enable-log-${{ github.event.pull_request.number }}
          path: pr_enable_log_${{ github.event.pull_request.number }}.md
