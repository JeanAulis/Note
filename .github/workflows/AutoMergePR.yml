name: Auto-Merge to Main (Full Features, Logging)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  prepare-prs:
    runs-on: ubuntu-latest
    outputs:
      pr_numbers: ${{ steps.get_prs.outputs.pr_numbers }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: å®‰è£… GitHub CLI
        run: |
          curl -sSL https://github.com/cli/cli/releases/download/v2.11.0/gh_2.11.0_linux_amd64.deb -o gh.deb
          sudo dpkg -i gh.deb
          sudo apt-get install -f

      - name: ç™»å½• GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: è·å–ç¬¦åˆæ¡ä»¶çš„ PR
        id: get_prs
        run: |
          REPO_OWNER=$(gh repo view ${{ github.repository }} --json owner -q ".owner.login")

          PR_NUMS=()
          LOG_ENTRIES=()
          SKIPPED_PRS=()

          # ========== DEBUG: æ‰“å°è§¦å‘ç±»å‹ ==========
          echo "=========================================="
          echo "ğŸ” DEBUG: å·¥ä½œæµè§¦å‘ç±»å‹ = $GITHUB_EVENT_NAME"
          echo "=========================================="

          # ========== DEBUG: è·å–æ‰€æœ‰å¼€æ”¾çš„ PR ==========
          echo ""
          echo "=========================================="
          echo "ğŸ” DEBUG: å¼€å§‹è·å–æ‰€æœ‰å¼€æ”¾çš„ PR..."
          ALL_PRS=$(gh pr list --state open --json number,createdAt,author,labels,baseRefName,mergeable)
          echo "ğŸ” DEBUG: æ‰€æœ‰å¼€æ”¾çš„ PR åŸå§‹æ•°æ®:"
          echo "$ALL_PRS" | jq '.'
          echo "=========================================="
          echo ""

          while read PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            PR_CREATED_AT=$(echo "$PR" | jq -r '.createdAt')
            PR_AUTHOR=$(echo "$PR" | jq -r '.author.login')
            PR_LABELS=$(echo "$PR" | jq -r '.labels[].name // empty')
            PR_BASE=$(echo "$PR" | jq -r '.baseRefName')
            PR_MERGEABLE=$(echo "$PR" | jq -r '.mergeable')

            # ========== DEBUG: æ‰“å°å½“å‰å¤„ç†çš„ PR ä¿¡æ¯ ==========
            echo ""
            echo "=========================================="
            echo "ğŸ” DEBUG: æ­£åœ¨å¤„ç† PR #$PR_NUMBER"
            echo "ğŸ” DEBUG: - ä½œè€…: $PR_AUTHOR"
            echo "ğŸ” DEBUG: - åˆ›å»ºæ—¶é—´: $PR_CREATED_AT"
            echo "ğŸ” DEBUG: - ç›®æ ‡åˆ†æ”¯: $PR_BASE"
            echo "ğŸ” DEBUG: - æ ‡ç­¾: $PR_LABELS"
            echo "ğŸ” DEBUG: - å¯åˆå¹¶çŠ¶æ€: $PR_MERGEABLE"
            echo "=========================================="

            LOG_MSG="PR #$PR_NUMBER"

            # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯
            if [ "$PR_BASE" != "main" ]; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ mainï¼Œè·³è¿‡"
              LOG_ENTRIES+=("$LOG_MSG ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ mainï¼Œè·³è¿‡")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ main")
              continue
            fi

            # æ£€æŸ¥å†²çªçŠ¶æ€
            if [ "$PR_MERGEABLE" = "CONFLICTING" ]; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER å­˜åœ¨åˆå¹¶å†²çªï¼Œè·³è¿‡"
              LOG_ENTRIES+=("$LOG_MSG å­˜åœ¨åˆå¹¶å†²çªï¼Œè·³è¿‡")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: å­˜åœ¨åˆå¹¶å†²çª âš ï¸")
              continue
            fi

            # æ£€æŸ¥ Auto-merge æ ‡ç­¾
            if ! echo "$PR_LABELS" | grep -q "Auto-merge"; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER ä¸åŒ…å« Auto-merge æ ‡ç­¾ï¼Œè·³è¿‡"
              LOG_ENTRIES+=("$LOG_MSG ä¸åŒ…å« Auto-merge æ ‡ç­¾ï¼Œè·³è¿‡")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: ä¸åŒ…å« Auto-merge æ ‡ç­¾")
              continue
            fi

            # å®¡æ‰¹æ£€æŸ¥
            PR_REVIEWS=$(gh pr view $PR_NUMBER --json reviews -q '.reviews[] | .state' 2>/dev/null || echo "")
            echo "ğŸ” DEBUG: PR #$PR_NUMBER å®¡æ‰¹çŠ¶æ€: $PR_REVIEWS"
            
            if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER ä½œè€…æ˜¯ä»“åº“æ‰€æœ‰è€…ï¼Œè·³è¿‡å®¡æ‰¹æ£€æŸ¥"
              LOG_ENTRIES+=("$LOG_MSG ä½œè€…æ˜¯ä»“åº“æ‰€æœ‰è€…ï¼Œè·³è¿‡å®¡æ‰¹æ£€æŸ¥")
            elif echo "$PR_REVIEWS" | grep -q "APPROVED"; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER å·²æ‰¹å‡†"
              LOG_ENTRIES+=("$LOG_MSG å·²æ‰¹å‡†")
            else
              echo "ğŸ” DEBUG: PR #$PR_NUMBER æœªæ‰¹å‡†ï¼Œè·³è¿‡åˆå¹¶"
              LOG_ENTRIES+=("$LOG_MSG æœªæ‰¹å‡†ï¼Œè·³è¿‡åˆå¹¶")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: æœªæ‰¹å‡†")
              continue
            fi

            PR_NUMS+=("$PR_NUMBER")
            echo "ğŸ” DEBUG: PR #$PR_NUMBER ç¬¦åˆåˆå¹¶æ¡ä»¶ âœ…"
            LOG_ENTRIES+=("$LOG_MSG ç¬¦åˆåˆå¹¶æ¡ä»¶ï¼Œå°†è¢«å¤„ç†")
          done < <(echo "$ALL_PRS" | jq -c '.[]')

          # æ‰“å°ç¬¦åˆæ¡ä»¶çš„ PR
          echo ""
          echo "=========================================="
          echo "âœ… ç¬¦åˆæ¡ä»¶çš„ PR åˆ—è¡¨:"
          if [ ${#PR_NUMS[@]} -eq 0 ]; then
            echo "æ— ç¬¦åˆæ¡ä»¶çš„ PR"
            LOG_ENTRIES+=("æ— ç¬¦åˆæ¡ä»¶çš„ PR")
          else
            for pr in "${PR_NUMS[@]}"; do
              echo "- PR #$pr"
              LOG_ENTRIES+=("ç¬¦åˆæ¡ä»¶çš„ PR: #$pr")
            done
          fi
          echo "=========================================="

          # æ‰“å°ä¸ç¬¦åˆæ¡ä»¶çš„ PR åŠå…¶åŸå› 
          echo ""
          echo "=========================================="
          echo "âŒ ä¸ç¬¦åˆæ¡ä»¶çš„ PR åŠå…¶åŸå› :"
          if [ ${#SKIPPED_PRS[@]} -eq 0 ]; then
            echo "æ— è¢«è¿‡æ»¤çš„ PR"
            LOG_ENTRIES+=("æ— è¢«è¿‡æ»¤çš„ PR")
          else
            for skipped in "${SKIPPED_PRS[@]}"; do
              echo "$skipped"
              LOG_ENTRIES+=("$skipped")
            done
          fi
          echo "=========================================="

          # è¾“å‡º PR åˆ—è¡¨ä¸º JSON
          echo "ğŸ” DEBUG: PR_NUMS æ•°ç»„å†…å®¹: ${PR_NUMS[@]}"
          echo "ğŸ” DEBUG: PR_NUMS æ•°ç»„é•¿åº¦: ${#PR_NUMS[@]}"
          
          if [ ${#PR_NUMS[@]} -eq 0 ]; then
            echo "pr_numbers=[]" >> $GITHUB_OUTPUT
            echo "ğŸ” DEBUG: è¾“å‡ºç©ºæ•°ç»„åˆ° GITHUB_OUTPUT"
          else
            # ç›´æ¥æ„é€  JSON æ•°ç»„ï¼Œä¸ä½¿ç”¨ç®¡é“
            PR_JSON="["
            for i in "${!PR_NUMS[@]}"; do
              if [ $i -eq 0 ]; then
                PR_JSON="${PR_JSON}${PR_NUMS[$i]}"
              else
                PR_JSON="${PR_JSON},${PR_NUMS[$i]}"
              fi
            done
            PR_JSON="${PR_JSON}]"
            echo "ğŸ” DEBUG: ç”Ÿæˆçš„ JSON: $PR_JSON"
            echo "pr_numbers=$PR_JSON" >> $GITHUB_OUTPUT
            echo "ğŸ” DEBUG: å·²è¾“å‡ºåˆ° GITHUB_OUTPUT"
          fi

          # ç”Ÿæˆæ—¥å¿—æ–‡ä»¶
          LOG_FILE="pr_merge_log.md"
          echo "# PR åˆå¹¶æ£€æŸ¥æ—¥å¿— - $(date)" > $LOG_FILE
          echo "" >> $LOG_FILE
          echo "## è§¦å‘ç±»å‹" >> $LOG_FILE
          echo "- $GITHUB_EVENT_NAME" >> $LOG_FILE
          echo "" >> $LOG_FILE
          echo "## è¯¦ç»†æ—¥å¿—" >> $LOG_FILE
          for entry in "${LOG_ENTRIES[@]}"; do
            echo "- $entry" >> $LOG_FILE
          done
          echo "ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ $LOG_FILE"
          cat $LOG_FILE

      - name: ä¸Šä¼ æ—¥å¿—ä¸º artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-merge-log
          path: pr_merge_log.md

  merge-prs:
    needs: prepare-prs
    runs-on: ubuntu-latest
    if: needs.prepare-prs.outputs.pr_numbers != '[]'  # é¿å…ç©ºçŸ©é˜µé”™è¯¯
    strategy:
      matrix:
        pr_number: ${{ fromJSON(needs.prepare-prs.outputs.pr_numbers) }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… GitHub CLI
        run: |
          curl -sSL https://github.com/cli/cli/releases/download/v2.11.0/gh_2.11.0_linux_amd64.deb -o gh.deb
          sudo dpkg -i gh.deb
          sudo apt-get install -f

      - name: ç™»å½• GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: è‡ªåŠ¨åˆå¹¶ PRï¼ˆå¸¦é‡è¯•æ—¥å¿—ï¼‰
        run: |
          PR_NUMBER=${{ matrix.pr_number }}
          MAX_RETRIES=3
          RETRY_INTERVAL=3600  # 1å°æ—¶
          LOG_FILE="pr_merge_log_${PR_NUMBER}.md"  # é¿å…æ—¥å¿—è¦†ç›–

          COUNT=0
          SUCCESS=false
          while [ $COUNT -lt $MAX_RETRIES ]; do
            ATTEMPT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            echo "[$ATTEMPT_TIME] å°è¯•ç¬¬ $((COUNT+1)) æ¬¡åˆå¹¶ PR #$PR_NUMBER..."
            if gh pr merge $PR_NUMBER --merge --auto --delete-branch; then
              echo "[$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶æˆåŠŸ"
              echo "- [$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶æˆåŠŸ âœ…" >> $LOG_FILE
              SUCCESS=true
              break
            else
              echo "[$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶å¤±è´¥ï¼Œç­‰å¾… $RETRY_INTERVAL ç§’åé‡è¯•..."
              echo "- [$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶å¤±è´¥ âŒ" >> $LOG_FILE
              COUNT=$((COUNT+1))
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "PR #$PR_NUMBER åˆå¹¶å¤±è´¥,è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $MAX_RETRIES"
            echo "- PR #$PR_NUMBER åˆå¹¶å¤±è´¥,è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° âŒ" >> $LOG_FILE
            exit 1
          fi

      - name: ä¸Šä¼ åˆå¹¶æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: pr-merge-log-${{ matrix.pr_number }}
          path: pr_merge_log_${{ matrix.pr_number }}.mdname: Auto-Merge to Main (Full Features, Logging)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  prepare-prs:
    runs-on: ubuntu-latest
    outputs:
      pr_numbers: ${{ steps.get_prs.outputs.pr_numbers }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: å®‰è£… GitHub CLI
        run: |
          curl -sSL https://github.com/cli/cli/releases/download/v2.11.0/gh_2.11.0_linux_amd64.deb -o gh.deb
          sudo dpkg -i gh.deb
          sudo apt-get install -f

      - name: ç™»å½• GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: è·å–ç¬¦åˆæ¡ä»¶çš„ PR
        id: get_prs
        run: |
          REPO_OWNER=$(gh repo view ${{ github.repository }} --json owner -q ".owner.login")

          PR_NUMS=()
          LOG_ENTRIES=()
          SKIPPED_PRS=()

          # ========== DEBUG: æ‰“å°è§¦å‘ç±»å‹ ==========
          echo "=========================================="
          echo "ğŸ” DEBUG: å·¥ä½œæµè§¦å‘ç±»å‹ = $GITHUB_EVENT_NAME"
          echo "=========================================="

          # ========== DEBUG: è·å–æ‰€æœ‰å¼€æ”¾çš„ PR ==========
          echo ""
          echo "=========================================="
          echo "ğŸ” DEBUG: å¼€å§‹è·å–æ‰€æœ‰å¼€æ”¾çš„ PR..."
          ALL_PRS=$(gh pr list --state open --json number,createdAt,author,labels,baseRefName,mergeable)
          echo "ğŸ” DEBUG: æ‰€æœ‰å¼€æ”¾çš„ PR åŸå§‹æ•°æ®:"
          echo "$ALL_PRS" | jq '.'
          echo "=========================================="
          echo ""

          while read PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            PR_CREATED_AT=$(echo "$PR" | jq -r '.createdAt')
            PR_AUTHOR=$(echo "$PR" | jq -r '.author.login')
            PR_LABELS=$(echo "$PR" | jq -r '.labels[].name // empty')
            PR_BASE=$(echo "$PR" | jq -r '.baseRefName')
            PR_MERGEABLE=$(echo "$PR" | jq -r '.mergeable')

            # ========== DEBUG: æ‰“å°å½“å‰å¤„ç†çš„ PR ä¿¡æ¯ ==========
            echo ""
            echo "=========================================="
            echo "ğŸ” DEBUG: æ­£åœ¨å¤„ç† PR #$PR_NUMBER"
            echo "ğŸ” DEBUG: - ä½œè€…: $PR_AUTHOR"
            echo "ğŸ” DEBUG: - åˆ›å»ºæ—¶é—´: $PR_CREATED_AT"
            echo "ğŸ” DEBUG: - ç›®æ ‡åˆ†æ”¯: $PR_BASE"
            echo "ğŸ” DEBUG: - æ ‡ç­¾: $PR_LABELS"
            echo "ğŸ” DEBUG: - å¯åˆå¹¶çŠ¶æ€: $PR_MERGEABLE"
            echo "=========================================="

            LOG_MSG="PR #$PR_NUMBER"

            # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯
            if [ "$PR_BASE" != "main" ]; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ mainï¼Œè·³è¿‡"
              LOG_ENTRIES+=("$LOG_MSG ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ mainï¼Œè·³è¿‡")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ main")
              continue
            fi

            # æ£€æŸ¥å†²çªçŠ¶æ€
            if [ "$PR_MERGEABLE" = "CONFLICTING" ]; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER å­˜åœ¨åˆå¹¶å†²çªï¼Œè·³è¿‡"
              LOG_ENTRIES+=("$LOG_MSG å­˜åœ¨åˆå¹¶å†²çªï¼Œè·³è¿‡")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: å­˜åœ¨åˆå¹¶å†²çª âš ï¸")
              continue
            fi

            # æ£€æŸ¥ Auto-merge æ ‡ç­¾
            if ! echo "$PR_LABELS" | grep -q "Auto-merge"; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER ä¸åŒ…å« Auto-merge æ ‡ç­¾ï¼Œè·³è¿‡"
              LOG_ENTRIES+=("$LOG_MSG ä¸åŒ…å« Auto-merge æ ‡ç­¾ï¼Œè·³è¿‡")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: ä¸åŒ…å« Auto-merge æ ‡ç­¾")
              continue
            fi

            # å®¡æ‰¹æ£€æŸ¥
            PR_REVIEWS=$(gh pr view $PR_NUMBER --json reviews -q '.reviews[] | .state' 2>/dev/null || echo "")
            echo "ğŸ” DEBUG: PR #$PR_NUMBER å®¡æ‰¹çŠ¶æ€: $PR_REVIEWS"
            
            if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER ä½œè€…æ˜¯ä»“åº“æ‰€æœ‰è€…ï¼Œè·³è¿‡å®¡æ‰¹æ£€æŸ¥"
              LOG_ENTRIES+=("$LOG_MSG ä½œè€…æ˜¯ä»“åº“æ‰€æœ‰è€…ï¼Œè·³è¿‡å®¡æ‰¹æ£€æŸ¥")
            elif echo "$PR_REVIEWS" | grep -q "APPROVED"; then
              echo "ğŸ” DEBUG: PR #$PR_NUMBER å·²æ‰¹å‡†"
              LOG_ENTRIES+=("$LOG_MSG å·²æ‰¹å‡†")
            else
              echo "ğŸ” DEBUG: PR #$PR_NUMBER æœªæ‰¹å‡†ï¼Œè·³è¿‡åˆå¹¶"
              LOG_ENTRIES+=("$LOG_MSG æœªæ‰¹å‡†ï¼Œè·³è¿‡åˆå¹¶")
              SKIPPED_PRS+=("- PR #$PR_NUMBER: æœªæ‰¹å‡†")
              continue
            fi

            PR_NUMS+=("$PR_NUMBER")
            echo "ğŸ” DEBUG: PR #$PR_NUMBER ç¬¦åˆåˆå¹¶æ¡ä»¶ âœ…"
            LOG_ENTRIES+=("$LOG_MSG ç¬¦åˆåˆå¹¶æ¡ä»¶ï¼Œå°†è¢«å¤„ç†")
          done < <(echo "$ALL_PRS" | jq -c '.[]')

          # æ‰“å°ç¬¦åˆæ¡ä»¶çš„ PR
          echo ""
          echo "=========================================="
          echo "âœ… ç¬¦åˆæ¡ä»¶çš„ PR åˆ—è¡¨:"
          if [ ${#PR_NUMS[@]} -eq 0 ]; then
            echo "æ— ç¬¦åˆæ¡ä»¶çš„ PR"
            LOG_ENTRIES+=("æ— ç¬¦åˆæ¡ä»¶çš„ PR")
          else
            for pr in "${PR_NUMS[@]}"; do
              echo "- PR #$pr"
              LOG_ENTRIES+=("ç¬¦åˆæ¡ä»¶çš„ PR: #$pr")
            done
          fi
          echo "=========================================="

          # æ‰“å°ä¸ç¬¦åˆæ¡ä»¶çš„ PR åŠå…¶åŸå› 
          echo ""
          echo "=========================================="
          echo "âŒ ä¸ç¬¦åˆæ¡ä»¶çš„ PR åŠå…¶åŸå› :"
          if [ ${#SKIPPED_PRS[@]} -eq 0 ]; then
            echo "æ— è¢«è¿‡æ»¤çš„ PR"
            LOG_ENTRIES+=("æ— è¢«è¿‡æ»¤çš„ PR")
          else
            for skipped in "${SKIPPED_PRS[@]}"; do
              echo "$skipped"
              LOG_ENTRIES+=("$skipped")
            done
          fi
          echo "=========================================="

          # è¾“å‡º PR åˆ—è¡¨ä¸º JSON
          echo "ğŸ” DEBUG: PR_NUMS æ•°ç»„å†…å®¹: ${PR_NUMS[@]}"
          echo "ğŸ” DEBUG: PR_NUMS æ•°ç»„é•¿åº¦: ${#PR_NUMS[@]}"
          
          if [ ${#PR_NUMS[@]} -eq 0 ]; then
            echo "pr_numbers=[]" >> $GITHUB_OUTPUT
            echo "ğŸ” DEBUG: è¾“å‡ºç©ºæ•°ç»„åˆ° GITHUB_OUTPUT"
          else
            # ç›´æ¥æ„é€  JSON æ•°ç»„ï¼Œä¸ä½¿ç”¨ç®¡é“
            PR_JSON="["
            for i in "${!PR_NUMS[@]}"; do
              if [ $i -eq 0 ]; then
                PR_JSON="${PR_JSON}${PR_NUMS[$i]}"
              else
                PR_JSON="${PR_JSON},${PR_NUMS[$i]}"
              fi
            done
            PR_JSON="${PR_JSON}]"
            echo "ğŸ” DEBUG: ç”Ÿæˆçš„ JSON: $PR_JSON"
            echo "pr_numbers=$PR_JSON" >> $GITHUB_OUTPUT
            echo "ğŸ” DEBUG: å·²è¾“å‡ºåˆ° GITHUB_OUTPUT"
          fi

          # ç”Ÿæˆæ—¥å¿—æ–‡ä»¶
          LOG_FILE="pr_merge_log.md"
          echo "# PR åˆå¹¶æ£€æŸ¥æ—¥å¿— - $(date)" > $LOG_FILE
          echo "" >> $LOG_FILE
          echo "## è§¦å‘ç±»å‹" >> $LOG_FILE
          echo "- $GITHUB_EVENT_NAME" >> $LOG_FILE
          echo "" >> $LOG_FILE
          echo "## è¯¦ç»†æ—¥å¿—" >> $LOG_FILE
          for entry in "${LOG_ENTRIES[@]}"; do
            echo "- $entry" >> $LOG_FILE
          done
          echo "ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ $LOG_FILE"
          cat $LOG_FILE

      - name: ä¸Šä¼ æ—¥å¿—ä¸º artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-merge-log
          path: pr_merge_log.md

  merge-prs:
    needs: prepare-prs
    runs-on: ubuntu-latest
    if: needs.prepare-prs.outputs.pr_numbers != '[]'  # é¿å…ç©ºçŸ©é˜µé”™è¯¯
    strategy:
      matrix:
        pr_number: ${{ fromJSON(needs.prepare-prs.outputs.pr_numbers) }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… GitHub CLI
        run: |
          curl -sSL https://github.com/cli/cli/releases/download/v2.11.0/gh_2.11.0_linux_amd64.deb -o gh.deb
          sudo dpkg -i gh.deb
          sudo apt-get install -f

      - name: ç™»å½• GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: è‡ªåŠ¨åˆå¹¶ PRï¼ˆå¸¦é‡è¯•æ—¥å¿—ï¼‰
        run: |
          PR_NUMBER=${{ matrix.pr_number }}
          MAX_RETRIES=3
          RETRY_INTERVAL=3600  # 1å°æ—¶
          LOG_FILE="pr_merge_log_${PR_NUMBER}.md"  # é¿å…æ—¥å¿—è¦†ç›–

          COUNT=0
          SUCCESS=false
          while [ $COUNT -lt $MAX_RETRIES ]; do
            ATTEMPT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            echo "[$ATTEMPT_TIME] å°è¯•ç¬¬ $((COUNT+1)) æ¬¡åˆå¹¶ PR #$PR_NUMBER..."
            if gh pr merge $PR_NUMBER --merge --auto --delete-branch; then
              echo "[$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶æˆåŠŸ"
              echo "- [$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶æˆåŠŸ âœ…" >> $LOG_FILE
              SUCCESS=true
              break
            else
              echo "[$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶å¤±è´¥ï¼Œç­‰å¾… $RETRY_INTERVAL ç§’åé‡è¯•..."
              echo "- [$ATTEMPT_TIME] PR #$PR_NUMBER åˆå¹¶å¤±è´¥ âŒ" >> $LOG_FILE
              COUNT=$((COUNT+1))
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "PR #$PR_NUMBER åˆå¹¶å¤±è´¥,è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $MAX_RETRIES"
            echo "- PR #$PR_NUMBER åˆå¹¶å¤±è´¥,è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° âŒ" >> $LOG_FILE
            exit 1
          fi

      - name: ä¸Šä¼ åˆå¹¶æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: pr-merge-log-${{ matrix.pr_number }}
          path: pr_merge_log_${{ matrix.pr_number }}.md
