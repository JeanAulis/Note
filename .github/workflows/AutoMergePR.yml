name: Auto-Merge to Main
# å½“PR opened, synchronize, reopened, labeled æ—¶æ‰§è¡Œ,åªå¤„ç†è§¦å‘çš„PR

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  check-pr:
    runs-on: ubuntu-latest
    outputs:
      should_merge: ${{ steps.check.outputs.should_merge }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ PR æ˜¯å¦ç¬¦åˆåˆå¹¶æ¡ä»¶
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_OWNER=$(gh repo view ${{ github.repository }} --json owner -q ".owner.login")
          LOG_FILE="pr_check_log_${PR_NUMBER}.md"

          echo "ğŸ” æ­£åœ¨æ£€æŸ¥ PR #$PR_NUMBER"
          echo "# PR #$PR_NUMBER æ£€æŸ¥æ—¥å¿— - $(date)" > $LOG_FILE
          echo "" >> $LOG_FILE

          # è·å– PR ä¿¡æ¯
          PR_INFO=$(gh pr view $PR_NUMBER --json author,labels,baseRefName,mergeable)
          PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')
          PR_LABELS=$(echo "$PR_INFO" | jq -r '.labels[].name // empty')
          PR_BASE=$(echo "$PR_INFO" | jq -r '.baseRefName')
          PR_MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')

          echo "## PR ä¿¡æ¯" >> $LOG_FILE
          echo "- ä½œè€…: $PR_AUTHOR" | tee -a $LOG_FILE
          echo "- ç›®æ ‡åˆ†æ”¯: $PR_BASE" | tee -a $LOG_FILE
          echo "- æ ‡ç­¾: $PR_LABELS" | tee -a $LOG_FILE
          echo "- å¯åˆå¹¶çŠ¶æ€: $PR_MERGEABLE" | tee -a $LOG_FILE
          echo "" >> $LOG_FILE

          echo "## æ£€æŸ¥ç»“æœ" >> $LOG_FILE
          SHOULD_MERGE=true

          # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯
          if [ "$PR_BASE" != "main" ]; then
            echo "âŒ ç›®æ ‡åˆ†æ”¯ä¸æ˜¯ main,è·³è¿‡åˆå¹¶" | tee -a $LOG_FILE
            SHOULD_MERGE=false
          else
            echo "âœ… ç›®æ ‡åˆ†æ”¯æ˜¯ main" | tee -a $LOG_FILE
          fi

          # æ£€æŸ¥å†²çªçŠ¶æ€
          if [ "$PR_MERGEABLE" = "CONFLICTING" ]; then
            echo "âŒ å­˜åœ¨åˆå¹¶å†²çª,è·³è¿‡åˆå¹¶" | tee -a $LOG_FILE
            SHOULD_MERGE=false
          else
            echo "âœ… æ— åˆå¹¶å†²çª" | tee -a $LOG_FILE
          fi

          # æ£€æŸ¥ Auto-merge æ ‡ç­¾
          if ! echo "$PR_LABELS" | grep -q "Auto-merge"; then
            echo "âŒ ä¸åŒ…å« Auto-merge æ ‡ç­¾,è·³è¿‡åˆå¹¶" | tee -a $LOG_FILE
            SHOULD_MERGE=false
          else
            echo "âœ… åŒ…å« Auto-merge æ ‡ç­¾" | tee -a $LOG_FILE
          fi

          # å®¡æ‰¹æ£€æŸ¥
          PR_REVIEWS=$(gh pr view $PR_NUMBER --json reviews -q '.reviews[] | .state' 2>/dev/null || echo "")
          
          if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
            echo "âœ… ä½œè€…æ˜¯ä»“åº“æ‰€æœ‰è€…,è·³è¿‡å®¡æ‰¹æ£€æŸ¥" | tee -a $LOG_FILE
          elif echo "$PR_REVIEWS" | grep -q "APPROVED"; then
            echo "âœ… PR å·²æ‰¹å‡†" | tee -a $LOG_FILE
          else
            echo "âŒ PR æœªæ‰¹å‡†,è·³è¿‡åˆå¹¶" | tee -a $LOG_FILE
            SHOULD_MERGE=false
          fi

          # è¾“å‡ºæœ€ç»ˆç»“æœ
          echo "" >> $LOG_FILE
          echo "## æœ€ç»ˆç»“æœ" >> $LOG_FILE
          if [ "$SHOULD_MERGE" = true ]; then
            echo "âœ… PR ç¬¦åˆåˆå¹¶æ¡ä»¶" | tee -a $LOG_FILE
          else
            echo "âŒ PR ä¸ç¬¦åˆåˆå¹¶æ¡ä»¶" | tee -a $LOG_FILE
          fi

          echo "should_merge=$SHOULD_MERGE" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æ£€æŸ¥æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-check-log-${{ github.event.pull_request.number }}
          path: pr_check_log_${{ github.event.pull_request.number }}.md

  merge-pr:
    needs: check-pr
    runs-on: ubuntu-latest
    if: needs.check-pr.outputs.should_merge == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå¹¶ PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          LOG_FILE="pr_merge_log_${PR_NUMBER}.md"

          echo "ğŸš€ å¼€å§‹åˆå¹¶ PR #$PR_NUMBER"
          echo "# PR #$PR_NUMBER åˆå¹¶æ—¥å¿— - $(date)" > $LOG_FILE
          echo "" >> $LOG_FILE
          echo "## åˆå¹¶è¿‡ç¨‹" >> $LOG_FILE
          
          MAX_RETRIES=3
          RETRY_INTERVAL=10
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            ATTEMPT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            echo "[$ATTEMPT_TIME] å°è¯•ç¬¬ $((COUNT+1))/$MAX_RETRIES æ¬¡åˆå¹¶..." | tee -a $LOG_FILE
            
            if gh pr merge $PR_NUMBER --merge; then
              echo "[$ATTEMPT_TIME] âœ… åˆå¹¶æˆåŠŸ" | tee -a $LOG_FILE
              SUCCESS=true
              break
            else
              MERGE_ERROR=$?
              echo "[$ATTEMPT_TIME] âŒ åˆå¹¶å¤±è´¥ (é”™è¯¯ç : $MERGE_ERROR)" | tee -a $LOG_FILE
              COUNT=$((COUNT+1))
              
              if [ $COUNT -lt $MAX_RETRIES ]; then
                echo "[$ATTEMPT_TIME] ç­‰å¾… $RETRY_INTERVAL ç§’åé‡è¯•..." | tee -a $LOG_FILE
                sleep $RETRY_INTERVAL
              fi
            fi
          done

          echo "" >> $LOG_FILE
          echo "## æœ€ç»ˆç»“æœ" >> $LOG_FILE
          if [ "$SUCCESS" = false ]; then
            echo "âŒ åˆå¹¶å¤±è´¥,å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $MAX_RETRIES" | tee -a $LOG_FILE
            exit 1
          else
            echo "âœ… åˆå¹¶æˆåŠŸ" | tee -a $LOG_FILE
          fi

      - name: ä¸Šä¼ åˆå¹¶æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-merge-log-${{ github.event.pull_request.number }}
          path: pr_merge_log_${{ github.event.pull_request.number }}.md
