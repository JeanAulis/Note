# 微信登陆

我们采用了双token三认证的一个方式来让用户无感登陆，减少了频繁登陆的操作。

我先说一下小程序登陆的大概步骤，首先，前端调用wx.login()获取临时登录凭证code和phoneCode，然后传给后端。后端拿到code后，结合配置的appid和appsecret，调用微信的接口获取用户的openid和session_key（如果用户已授权给同主体其他应用时才返回UnionID）。接着，根据openid查询数据库**判断用户是否已存在**，如果不存在就**创建新用户**并且绑定手机号；如果用户已存在，跳过注册，检查用户是否绑定手机或者更新手机号，后端就会**更新手机号**；获取手机号的步骤大概是这样的：

后端先根据接口（需要grant_type、appid、secret）获取access_token，再根据前端传入的code（phoneCode）和access_token（URL参数）向微信接口发起请求获取手机号。

最后，将用户信息封装到**`Access Token`**和**`Refresh Token`**中，返回给小程序，后续的业务请求都携带这个Access Token（短token）。

对于双token三认证，在刚刚的基础上，我们加了一个单次使用的Refresh Token（长token）来刷新token，用户就可以无感登陆；我们把这个长token存入Redis，并且设置一个24小时的过期时间，当用户的短token过期时，去Redis查询是否存在，如果不存在的话，说明已经过期或者被使用，后端就会拒绝刷新令牌操作，强制用户登录。如果还存在的话，我们就刷新短token，并且刷新对应的长token。

---

双token：

- **短 Token（Access Token）**：有效期短（如30分钟），用于业务接口访问。
- **长 Token（Refresh Token）**：有效期长（24小时），存入 Redis，仅能使用一次。

三认证：账号密码认证（手机号或者微信code登陆认证）；短token认证；长token认证



# 微信消息订阅

需要获取的内容：openid、Access Token(缓存到Redis，2个小时过期，定时获取)、模板ID

1. 新增一个通知模版
2. 用户授权订阅，获取用户openid（根据JWT解析用户信息，到数据库查openid），添加订阅
3. MQTT消息监听器监听(也可以从阿里云IoT平台用线程池接收，然后采用定时任务进行监听处理)
4. 发送订阅信息（POST请求给sendMessage接口）

